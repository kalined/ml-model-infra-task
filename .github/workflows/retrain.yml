name: Retrain MNIST Model

on:
  pull_request:
    paths:
      - 'notebook-mnist.ipynb'
      - 'mnist_images/**'

jobs:
  retrain:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Determine latest week
        id: pick_week
        run: |
          latest=$(ls mnist_images/weeks \
                   | grep -E '^week [0-9]+' \
                   | sort -V \
                   | tail -n1)
          echo "WEEK=$latest" >> $GITHUB_ENV

      - name: Check contents of latest week
        run: |
          echo "Checking contents of ./mnist_images/weeks/${{ env.WEEK }}/"
          ls -la "./mnist_images/weeks/${{ env.WEEK }}/"

      - name: Unpack images into latest week
        run: |
          rm -f "./mnist_images/weeks/${{ env.WEEK }}/.gitkeep"

          tar --strip-components=1 -xf "./mnist_images/weeks/${{ env.WEEK }}/mnist-images.tar.gz" -C "./mnist_images/weeks/${{ env.WEEK }}/"

          echo "Contents of ./mnist_images/weeks/${{ env.WEEK }}/ after extraction:"
          ls -la "./mnist_images/weeks/${{ env.WEEK }}/"

      - name: Set up Python
        uses: actions/setup-python@v4
        with: 
            python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install notebook papermill

      - name: Execute notebook on ${{ env.WEEK }}
        run: |
          papermill notebook-mnist.ipynb \
                    retrained.ipynb \
                    -p WEEK "${{ env.WEEK }}" \
                    --log-output
        shell: bash

      - name: Upload retrained model
        uses: actions/upload-artifact@v4
        with:
          name: mnist_model_${{ env.WEEK }}
          path: supported_model/mnist_model.h5

      - name: Get list of artifacts
        id: get-artifacts
        run: |
          # Fetch the list of artifacts from the GitHub API
          curl -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/artifacts > artifacts.json

          # production model artifact
          prod_artifact=$(jq -r '
            .artifacts
            | map(select(.name | test("_production")))
            | sort_by(.created_at)
            | reverse
            | .[0]
          ' artifacts.json)

          prod_artifact_id=$(echo "$prod_artifact" | jq -r '.id')

          if [ -z "$prod_artifact_id" ]; then
            echo "Error: No production artifact found."
            exit 1
          fi

          # Extract artifact details for debugging
          prod_artifact_name=$(echo "$prod_artifact" | jq -r '.name')
          prod_artifact_created_at=$(echo "$prod_artifact" | jq -r '.created_at')
          prod_artifact_run_id=$(echo "$prod_artifact" | jq -r '.workflow_run.id')

          echo "Selected production artifact:"
          echo "  ID: $prod_artifact_id"
          echo "  Name: $prod_artifact_name"
          echo "  Created At: $prod_artifact_created_at"
          echo "  Workflow Run ID: $prod_artifact_run_id"

          echo "prod_artifact_id=$prod_artifact_id" >> $GITHUB_ENV
          echo "prod_artifact_run_id=$prod_artifact_run_id" >> $GITHUB_ENV

          # new model artifact (anything starting with "mnist_model")
          new_artifact=$(jq -r '
            .artifacts
            | map(select(.name | startswith("mnist_model")))
            | sort_by(.created_at)
            | reverse
            | .[0]
          ' artifacts.json)

          new_artifact_id=$(echo "$new_artifact" | jq -r '.id')

          if [ -z "$new_artifact_id" ]; then
            echo "Error: No new model artifact found."
            exit 1
          fi

          # Extract artifact details for debugging
          new_artifact_name=$(echo "$new_artifact" | jq -r '.name')
          new_artifact_created_at=$(echo "$new_artifact" | jq -r '.created_at')
          new_artifact_run_id=$(echo "$new_artifact" | jq -r '.workflow_run.id')

          # Print artifact details
          echo "Selected new model artifact:"
          echo "  ID: $new_artifact_id"
          echo "  Name: $new_artifact_name"
          echo "  Created At: $new_artifact_created_at"
          echo "  Workflow Run ID: $new_artifact_run_id"

          echo "new_artifact_id=$new_artifact_id" >> $GITHUB_ENV
          echo "new_artifact_run_id=$new_artifact_run_id" >> $GITHUB_ENV

      - name: Evaluate new model
        id: evaluate-new-model
        uses: ./.github/actions/evaluate-models
        with:
          new_artifact_id: ${{ env.new_artifact_id }}
          prod_artifact_id: ${{ env.prod_artifact_id }}
          prod_artifact_run_id: ${{ env.prod_artifact_run_id }}
          new_artifact_run_id: ${{ env.new_artifact_run_id }}
          github_token: ${{ secrets.GH_PAT }}

      - name: Get the result of the evaluation
        run: |
          if [ "${{ steps.evaluate-new-model.outputs.result }}" = "old" ]; then
            echo "::error New model performs worse. Rolling back to the production model."
            exit 1
          else
            echo "New model performs better. You can proceed with the deployment."
          fi